name: ğŸš€ CI/CD Pipeline - CSGA Quality Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily quality checks at 02:00 UTC
    - cron: '0 2 * * *'

env:
  JULIA_VERSION: '1.9'
  JULIA_NUM_THREADS: 4

jobs:
  # =============================================================================
  # JOB 1: SETUP E VALIDAÃ‡ÃƒO BÃSICA
  # =============================================================================
  setup:
    name: ğŸ”§ Setup & Basic Validation
    runs-on: ubuntu-latest
    outputs:
      julia-version: ${{ steps.setup.outputs.julia-version }}
      cache-key: ${{ steps.cache.outputs.cache-key }}

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Julia
      id: setup
      uses: julia-actions/setup-julia@v1
      with:
        version: ${{ env.JULIA_VERSION }}

    - name: ğŸ“¦ Cache Dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.julia
          ~/.julia/packages
        key: julia-${{ env.JULIA_VERSION }}-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}
        restore-keys: |
          julia-${{ env.JULIA_VERSION }}-

    - name: ğŸ“‹ Project Info
      run: |
        echo "ğŸ·ï¸ Julia Version: $(julia --version)"
        echo "ğŸ“ Project Structure:"
        find . -name "*.jl" -type f | head -10
        echo "ğŸ“Š Project Stats:"
        echo "  - Julia files: $(find . -name "*.jl" -type f | wc -l)"
        echo "  - Test files: $(find . -path "*/test/*.jl" -type f | wc -l)"

  # =============================================================================
  # JOB 2: TESTES UNITÃRIOS COMPLETOS
  # =============================================================================
  test:
    name: ğŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest
    needs: setup

    strategy:
      fail-fast: false
      matrix:
        julia-version: ['1.8', '1.9', '1.10']

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Julia ${{ matrix.julia-version }}
      uses: julia-actions/setup-julia@v1
      with:
        version: ${{ matrix.julia-version }}

    - name: ğŸ“¦ Restore Cache
      uses: actions/cache@v3
      with:
        path: ~/.julia
        key: julia-${{ matrix.julia-version }}-${{ hashFiles('**/Project.toml') }}

    - name: ğŸ”§ Install Dependencies
      run: |
        julia --project=. -e 'using Pkg; Pkg.instantiate()'

    - name: ğŸ§ª Run Tests
      run: |
        julia --project=. -e 'using Pkg; Pkg.test(coverage=true)'

    - name: ğŸ“Š Coverage Report
      if: matrix.julia-version == '1.9'
      run: |
        julia --project=. -e '
          using Pkg
          Pkg.add("Coverage")
          using Coverage
          coverage = process_folder()
          covered_lines, total_lines = get_summary(coverage)
          percentage = covered_lines / total_lines * 100
          println("ğŸ“Š Coverage: $(round(percentage, digits=2))% ($(covered_lines)/$(total_lines) lines)")

          # Generate detailed report
          open("coverage_report.txt", "w") do f
            println(f, "# Coverage Report")
            println(f, "")
            println(f, "**Overall Coverage:** $(round(percentage, digits=2))%")
            println(f, "**Covered Lines:** $(covered_lines)")
            println(f, "**Total Lines:** $(total_lines)")
            println(f, "")
            println(f, "## File-by-File Coverage:")
            for (filename, file_cov) in coverage
              file_covered = count(x -> x != nothing && x > 0, file_cov.coverage)
              file_total = count(x -> x != nothing, file_cov.coverage)
              if file_total > 0
                file_percentage = file_covered / file_total * 100
                println(f, "- **$(filename):** $(round(file_percentage, digits=1))% ($(file_covered)/$(file_total))")
              end
            end
          end
        '

    - name: ğŸ“¤ Upload Coverage Report
      if: matrix.julia-version == '1.9'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage_report.txt

  # =============================================================================
  # JOB 3: CSGA QUALITY GATES
  # =============================================================================
  quality:
    name: ğŸ¯ CSGA Quality Assessment
    runs-on: ubuntu-latest
    needs: setup

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: ${{ env.JULIA_VERSION }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        julia --project=. -e 'using Pkg; Pkg.instantiate()'

    - name: ğŸ¯ CSGA Quality Assessment
      id: csga
      run: |
        julia --project=. -e '
          using Automation

          println("ğŸ¯ Executando avaliaÃ§Ã£o CSGA completa...")
          result = evaluate_project(".")

          println("ğŸ“Š CSGA QUALITY REPORT")
          println("=" ^ 50)
          println("ğŸ† Overall Score: $(round(result.overall_score, digits=1))/100")
          println("ğŸ›¡ï¸  Security: $(round(result.security_pillar.score, digits=1))/100")
          println("ğŸ§¹ Clean Code: $(round(result.clean_code_pillar.score, digits=1))/100")
          println("ğŸŒ± Green Code: $(round(result.green_code_pillar.score, digits=1))/100")
          println("ğŸ¤– Automation: $(round(result.automation_pillar.score, digits=1))/100")
          println("ğŸ“ˆ Maturity Level: $(result.maturity_level)")

          # Set output variables for other jobs
          println("::set-output name=overall_score::$(result.overall_score)")
          println("::set-output name=maturity_level::$(result.maturity_level)")

          # Quality gates
          if result.overall_score < 85.0
            println("âŒ QUALITY GATE FAILED: Overall score $(round(result.overall_score, digits=1)) < 85.0")
            exit(1)
          else
            println("âœ… QUALITY GATE PASSED: $(result.maturity_level) level achieved")
          end
        '

    - name: ğŸŒ± Green Code Showcase
      run: |
        julia --project=. -e '
          include("src/green_code_integration.jl")
          showcase_result = green_code_showcase()

          println("ğŸŒ± GREEN CODE SHOWCASE")
          println("=" ^ 30)
          for (key, value) in showcase_result
            println("$(key): $(round(value, digits=1))")
          end

          green_score = get(showcase_result, "green_code_score", 0.0)
          if green_score < 90.0
            println("âš ï¸  GREEN CODE WARNING: Score $(round(green_score, digits=1)) < 90.0")
          else
            println("ğŸŒŸ GREEN CODE EXCELLENT: $(round(green_score, digits=1))/100")
          end
        '

  # =============================================================================
  # JOB 4: FORMATAÃ‡ÃƒO E LINTING
  # =============================================================================
  formatting:
    name: ğŸ“ Code Formatting & Linting
    runs-on: ubuntu-latest
    needs: setup

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: ${{ env.JULIA_VERSION }}

    - name: ğŸ“¦ Install JuliaFormatter
      run: |
        julia -e 'using Pkg; Pkg.add("JuliaFormatter")'

    - name: ğŸ“ Check Formatting
      run: |
        julia -e '
          using JuliaFormatter

          println("ğŸ“ Checking code formatting...")
          formatted = format(".", verbose=true, overwrite=false)

          if !formatted
            println("âŒ Code formatting issues found!")
            println("ğŸ’¡ Run: julia -e \"using JuliaFormatter; format(\\\".\\\")\")")
            exit(1)
          else
            println("âœ… Code formatting is correct")
          end
        '

  # =============================================================================
  # JOB 5: SECURITY SCAN
  # =============================================================================
  security:
    name: ğŸ”’ Security Scanning
    runs-on: ubuntu-latest
    needs: setup

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ” Scan for Secrets
      run: |
        echo "ğŸ” Scanning for potential secrets..."

        # Check for common secret patterns
        if grep -r -i -E "(password|secret|api_key|token|private_key)" --include="*.jl" .; then
          echo "âš ï¸  Potential secrets found in code"
          echo "Please review the files above for sensitive information"
        else
          echo "âœ… No obvious secrets detected"
        fi

    - name: ğŸ›¡ï¸ Dependency Security Check
      run: |
        echo "ğŸ›¡ï¸ Checking dependencies for known vulnerabilities..."
        echo "â„¹ï¸  (This is a placeholder - implement with actual security scanning tools)"
        echo "âœ… Dependency security check passed"

  # =============================================================================
  # JOB 6: PERFORMANCE BENCHMARKS
  # =============================================================================
  benchmarks:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: ${{ env.JULIA_VERSION }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        julia --project=. -e 'using Pkg; Pkg.instantiate()'
        julia -e 'using Pkg; Pkg.add("BenchmarkTools")'

    - name: âš¡ Run Benchmarks
      run: |
        julia --project=. -e '
          using BenchmarkTools
          include("src/green_code_integration.jl")

          println("âš¡ Running performance benchmarks...")

          # Benchmark quality analyzer
          if isfile("src/quality_analyzer_optimized.jl")
            include("src/quality_analyzer_optimized.jl")

            println("ğŸ“Š Quality Analyzer Benchmark:")
            benchmark_result = @benchmark analyze_file_optimized("src/Automation.jl") samples=5 evals=1

            median_time_ms = median(benchmark_result.times) / 1e6
            median_memory_kb = median(benchmark_result.memory) / 1024

            println("  Time: $(round(median_time_ms, digits=2))ms")
            println("  Memory: $(round(median_memory_kb, digits=2))KB")

            if median_time_ms > 100
              println("âš ï¸  Performance regression: Analysis time > 100ms")
            else
              println("âœ… Performance within acceptable limits")
            end
          end
        '

    - name: ğŸ“Š Generate Performance Report
      run: |
        echo "ğŸ“Š Performance benchmarks completed"
        echo "ğŸ“ˆ Results logged above"

  # =============================================================================
  # JOB 7: BUILD E DEPLOY (DOCUMENTAÃ‡ÃƒO)
  # =============================================================================
  documentation:
    name: ğŸ“š Build Documentation
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: ${{ env.JULIA_VERSION }}

    - name: ğŸ“¦ Install Documenter
      run: |
        julia --project=docs -e 'using Pkg; Pkg.develop(PackageSpec(path=pwd())); Pkg.instantiate()'

    - name: ğŸ“š Build Documentation
      run: |
        julia --project=docs docs/make.jl

    - name: ğŸš€ Deploy Documentation
      if: github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/build
        publish_branch: gh-pages

  # =============================================================================
  # JOB 8: NOTIFICAÃ‡ÃƒO DE RESULTADOS
  # =============================================================================
  notification:
    name: ğŸ“¢ Results Notification
    runs-on: ubuntu-latest
    needs: [test, quality, formatting, security, benchmarks]
    if: always()

    steps:
    - name: ğŸ“Š Pipeline Summary
      run: |
        echo "ğŸš€ CI/CD Pipeline Completed"
        echo "================================"
        echo "ğŸ“¥ Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ’¾ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo ""
        echo "ğŸ“‹ Job Results:"
        echo "  ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "  ğŸ¯ Quality: ${{ needs.quality.result }}"
        echo "  ğŸ“ Formatting: ${{ needs.formatting.result }}"
        echo "  ğŸ”’ Security: ${{ needs.security.result }}"
        echo "  âš¡ Benchmarks: ${{ needs.benchmarks.result }}"
        echo ""

        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.quality.result }}" == "success" ]]; then
          echo "âœ… Pipeline PASSED - Ready for deployment"
        else
          echo "âŒ Pipeline FAILED - Review issues above"
        fi
